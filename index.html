<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SecCoach - Quiz szkoleniowy</title>

  <meta name="description" content="SecCoach - interaktywny quiz z cyberbezpieczeństwa dla pracowników.">
  <meta property="og:title" content="SecCoach - Quiz szkoleniowy">
  <meta property="og:description" content="Szybki quiz z cyberbezpieczeństwa dla pracowników.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="assets/logo-seccoach.png">
  <link rel="icon" type="image/png" href="assets/logo-seccoach.png">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#38bdf8; --accent-2:#34d399; --danger:#f43f5e; --warn:#f59e0b;
      --card:#0b1220; --border:#1f2937; --shadow:0 10px 25px rgba(0,0,0,.35);
      --radius:16px;
    }
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,sans-serif}
    body.no-scroll{overflow:hidden}
    .light{ --bg:#f8fafc;--panel:#fff;--text:#0b1220;--muted:#475569;--border:#e2e8f0;--card:#fff; background:#f8fafc;color:#0b1220 }

    /* Tryb dostępności */
    body.accessible{ font-size:18px; line-height:1.7; }
    body.accessible .panel{ background:#111827; }
    body.accessible .option{ background:#fff; color:#000; border:2px solid #000; }
    body.accessible .btn{ background:#fff; color:#000; border:2px solid #000; padding:12px 14px; font-weight:700; }
    body.accessible .btn.primary{ background:linear-gradient(135deg,#fff,#e5e7eb); color:#000; border:2px solid #000; }
    body.accessible .pill{ background:#fff; color:#000; border:2px solid #000; }
    body.accessible :focus{ outline:3px solid #ffbf47; outline-offset:3px; }
    body.accessible #timer{ color:#ffbf47; }

    .site-header{ position:sticky;top:0;z-index:1000;display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 16px;background:rgba(15,23,42,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .light .site-header{background:rgba(255,255,255,.85)}
    .site-logo img{display:block;height:clamp(32px,6vw,66px)}
    .site-actions{display:flex;gap:8px}
    .btn{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:10px;padding:8px 10px;font-weight:600;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#0b1220;border:none}

    .container{max-width:960px;margin:0 auto;padding:0 20px 40px}
    .panel{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin-top:20px}
    .row{margin:10px 0;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{min-width:180px;color:var(--muted)}
    select,input,button{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:10px;padding:10px 12px;font-size:15px}
    input:invalid{border-color:var(--danger)} input:valid{border-color:#334155}
    button,.option,input,select{transition:background .2s,border-color .2s,transform .1s}
    button:active{transform:scale(.98)} button:disabled{opacity:.6;cursor:not-allowed}
    .pill{padding:3px 10px;border-radius:999px;background:#0b1220;border:1px solid var(--border);font-size:13px;color:var(--muted)}
    .bar-wrap{display:flex;gap:10px;align-items:center}
    .bar{flex:1;height:8px;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%;transition:.3s;border-radius:8px}
    .percent{min-width:46px;text-align:right;color:var(--muted);font-weight:700}
    .answers{display:grid;gap:8px;margin:10px 0}
    .option{padding:12px;border:1px solid var(--border);border-radius:12px;background:#0e1627;text-align:left}
    .light .option{background:#f1f5f9}
    .option.correct{border-color:var(--accent-2);background:rgba(52,211,153,.1)}
    .option.wrong{border-color:var(--danger);background:rgba(244,63,94,.1)}
    .dots{display:flex;justify-content:center;gap:6px;margin-bottom:8px;flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:50%;background:#1f2937;cursor:pointer}
    .dot.active{background:var(--accent)}
    #timer{font-weight:700;color:var(--accent);text-align:center;margin-top:5px}

    .toast{position:fixed;left:50%;bottom:15px;transform:translateX(-50%);background:#0b1220;border:1px solid var(--border);color:var(--text);padding:10px 16px;border-radius:12px;opacity:0;transition:.25s}
    .toast.show{opacity:1}

    .modal{ position:fixed; inset:0; z-index:5000; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; padding:20px; }
    .modal.show{display:flex}
    .modal-content{ background:var(--panel); border:1px solid var(--border); color:var(--text);
      border-radius:16px; padding:22px; max-width:700px; width:100%; max-height:90vh; overflow:auto; box-shadow:var(--shadow); }

    .site-footer{max-width:960px;margin:24px auto;padding:0 20px;color:var(--muted);text-align:center}
    .q-img{ width:100%; min-height:180px; display:flex; align-items:center; justify-content:center; flex-direction:column; border-radius:18px; border:1px solid var(--border); background:transparent; overflow:hidden; margin:10px 0 14px; }
    .q-img img{ max-width:100%; max-height:260px; object-fit:contain; display:block; border-radius:16px; background:transparent; box-shadow:0 4px 10px rgba(0,0,0,.3); }
    .q-img figcaption{ font-size:13px; color:var(--muted); text-align:center; margin-top:6px; }

    .kpi{display:flex;flex-direction:column;gap:4px;padding:12px 16px;border:1px solid var(--border);background:rgba(255,255,255,.02);border-radius:12px;min-width:160px}
    .kpi .kpi-label{color:var(--muted);font-size:13px}
    .kpi .kpi-value{font-size:20px;font-weight:800}
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse;min-width:640px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    thead th{position:sticky;top:0;background:#0b1220}
    .light thead th{background:#e2e8f0}
    tbody tr:hover{background:#0e1627}
    .light tbody tr:hover{background:#f8fafc}
    .admin-badge{margin-left:8px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
  </style>
</head>
<body>
  <header class="site-header">
    <a href="login.html" class="site-logo" aria-label="Strona główna SecCoach">
      <img src="assets/logo-seccoach.png" alt="SecCoach - logo"/>
    </a>
    <div class="site-actions">
      <span id="userEmail" class="pill" aria-live="polite">Użytkownik</span>
      <span id="adminBadge" class="admin-badge" style="display:none;">ADMIN</span>
      <button id="themeToggle" class="btn" title="Przełącz motyw">🌓</button>
      <button id="logoutBtn" class="btn">Wyloguj</button>
    </div>
  </header>

  <main class="container" id="main">
    <section class="panel" id="settings" aria-labelledby="ustawieniaTitle">
      <h2 id="ustawieniaTitle">Ustawienia</h2>
      <div class="row">
        <label for="category">Kategoria:</label>
        <select id="category" aria-label="Wybierz kategorię pytań">
          <option value="latwe">Łatwe</option>
          <option value="srednie">Średnie</option>
          <option value="trudne">Zaawansowane</option>
          <option value="mix">Miks</option>
        </select>
      </div>
      <div class="row">
        <label for="count">Liczba pytań:</label>
        <input id="count" type="number" min="1" max="10" value="10" aria-label="Liczba pytań">
      </div>
      <div class="row">
        <button id="startBtn" class="btn primary" disabled>Rozpocznij quiz</button>
        <button id="accessibilityBtn" class="btn">Tryb dostępności</button>
        <button id="demoBtn" class="btn" title="Wygeneruj 50 przykładowych wyników">Symulacja (50 wyników)</button>
        <button id="statsBtn" class="btn" title="Pokaż statystyki i historię wyników">Statystyki</button>
      </div>
    </section>

    <section class="panel" id="quiz" style="display:none;">
      <div id="timer">Czas: 05:00</div>
      <div class="dots" id="dots" aria-label="Nawigacja po pytaniach"></div>
      <div class="row" style="justify-content:space-between;">
        <div class="pill">Pytanie <span id="qIndex">0</span>/<span id="qTotal">0</span></div>
        <div class="bar-wrap" style="flex:1; margin-left:10px;">
          <div class="bar" id="bar" aria-hidden="true"></div>
          <div class="percent" id="percent">0%</div>
        </div>
      </div>

      <figure class="q-img" id="qImageBox">
        <img id="qImage" alt="Obraz ilustrujący pytanie"/>
        <figcaption id="qImageCap">Miejsce na grafikę (opcjonalnie)</figcaption>
      </figure>

      <h3 id="qText" tabindex="0" aria-live="polite"></h3>
      <div id="answers" class="answers" role="radiogroup" aria-label="Odpowiedzi"></div>
      <div id="explanation" style="color:var(--muted);font-size:14px;margin-top:6px;"></div>

      <div class="row">
        <button id="prevBtn" class="btn" aria-label="Poprzednie pytanie">Wstecz</button>
        <button id="nextBtn" class="btn primary" aria-label="Następne pytanie">Dalej</button>
      </div>
    </section>

    <section class="panel" id="result" style="display:none;">
      <h2>Wynik</h2>
      <div id="score"></div>
      <div class="row" style="gap:8px;flex-wrap:wrap;">
        <button id="retryBtn" class="btn primary">Zagraj ponownie</button>
        <button id="downloadCsv" class="btn primary">Pobierz historię (CSV)</button>
      </div>
    </section>

    <section class="panel" id="stats" style="display:none;">
      <h2>Statystyki</h2>
      <div class="row" id="statsSummary"></div>
      <div class="row">
        <div class="panel" style="flex:1; padding:16px;">
          <h3 style="margin-top:0;">Ranking TOP 5</h3>
          <ol id="leaderboard" style="margin:0; padding-left:18px;"></ol>
        </div>
      </div>
      <div class="row" style="display:grid;grid-template-columns:1fr;gap:16px">
        <canvas id="chartScores" height="160" aria-label="Rozkład wyników" role="img"></canvas>
        <canvas id="chartLevels" height="160" aria-label="Udział poziomów" role="img"></canvas>
        <canvas id="chartTimeline" height="160" aria-label="Próby w czasie" role="img"></canvas>
      </div>
      <div class="row" style="justify-content:space-between; margin-top:10px;">
        <div>
          <button id="refreshStats" class="btn">Odśwież</button>
          <button id="clearHistory" class="btn">Wyczyść historię</button>
          <button id="exportJson" class="btn">Eksport JSON</button>
        </div>
        <button id="downloadCsv2" class="btn primary">Pobierz historię (CSV)</button>
      </div>
      <div class="table-wrap" style="margin-top:10px;">
        <table class="table" id="historyTable">
          <thead><tr><th>#</th><th>E-mail</th><th>Wynik</th><th>Pyt.</th><th>Czas (s)</th><th>Data</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <button id="aboutBtn" class="btn primary" style="margin-top:20px;">O projekcie</button>
  </main>
  <div id="aboutModal" class="modal" aria-modal="true" role="dialog" aria-labelledby="aboutTitle">
    <div class="modal-content">
      <h2 id="aboutTitle">O projekcie</h2>
      <p><strong>SecCoach</strong> - interaktywny quiz zwiększający świadomość cyberbezpieczeństwa pracowników.</p>
      <p>Wykonany w ramach <em>Technologie aplikacji mobilnych</em>. Projekt wykonany na <strong>Uniwersytecie WSB Merito w Bydgoszczy</strong>. Stack: HTML, CSS, JS, GitHub Pages.</p>
      <p>Autorzy: Damian Król, Angelika Adamczewska.</p>
      <button id="closeAbout" class="btn primary">Zamknij</button>
    </div>
  </div>

  <footer class="site-footer">
    <small>© 2025 SecCoach • Wersja 2.36 • Projekt wykonany na Uniwersytecie WSB Merito w Bydgoszczy</small>
  </footer>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>
<script>
  /* ===== STAN / ELEMENTY ===== */
  let questions = { latwe:[], srednie:[], trudne:[] };
  let state = { pool: [], current: 0, answers: [], timer: 300, initialTimer: 300 };
  let timerInterval, charts = {};
  let isAdmin = localStorage.getItem('isAdmin') === '1';

  const $ = (id)=>document.getElementById(id);
  const els = {
    themeToggle: $('themeToggle'),
    logoutBtn: $('logoutBtn'),
    userEmail: $('userEmail'),
    adminBadge: $('adminBadge'),
    category: $('category'),
    count: $('count'),
    startBtn: $('startBtn'),
    settings: $('settings'),
    quiz: $('quiz'),
    result: $('result'),
    qText: $('qText'),
    answers: $('answers'),
    qIndex: $('qIndex'),
    qTotal: $('qTotal'),
    bar: $('bar'),
    percent: $('percent'),
    nextBtn: $('nextBtn'),
    prevBtn: $('prevBtn'),
    explanation: $('explanation'),
    score: $('score'),
    retryBtn: $('retryBtn'),
    timer: $('timer'),
    dots: $('dots'),
    toast: $('toast'),
    accessibilityBtn: $('accessibilityBtn'),
    aboutBtn: $('aboutBtn'),
    aboutModal: $('aboutModal'),
    closeAbout: $('closeAbout'),
    qImage: $('qImage'),
    qImageCap: $('qImageCap'),
    statsBtn: $('statsBtn'),
    stats: $('stats'),
    statsSummary: $('statsSummary'),
    leaderboard: $('leaderboard'),
    refreshStats: $('refreshStats'),
    clearHistory: $('clearHistory'),
    downloadCsv: $('downloadCsv'),
    downloadCsv2: $('downloadCsv2'),
    exportJson: $('exportJson'),
    historyTableBody: document.querySelector('#historyTable tbody'),
    demoBtn: $('demoBtn')
  };

  /* ===== THEME ===== */
  const savedTheme = localStorage.getItem('seccoach_theme') || 'dark';
  if(savedTheme==='light') document.body.classList.add('light');
  els.themeToggle.onclick = ()=>{
    document.body.classList.toggle('light');
    localStorage.setItem('seccoach_theme', document.body.classList.contains('light') ? 'light' : 'dark');
  };

  /* ===== AUTH ===== */
  const email = localStorage.getItem('quizUserEmail') || '';
  if(!email){ location.href = 'login.html'; }
  els.userEmail.textContent = email;
  if(isAdmin){ els.adminBadge.style.display = 'inline-flex'; }

  /* ===== TOAST ===== */
  function toast(msg){ els.toast.textContent = msg; els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'),2000); }

  /* ===== POMOCNICZE ===== */
  function clampCount(max){
    const raw = String(els.count.value || '').replace(/[^0-9]/g,'');
    let n = parseInt(raw,10); if(isNaN(n)||n<1) n=1; if(max) n=Math.min(n,max);
    els.count.value = String(n); return n;
  }
  function percent(score,total){ return total>0 ? Math.round((score/total)*100) : 0; }
  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }

  /* ===== TRYB DOSTĘPNOŚCI ===== */
  els.accessibilityBtn.onclick = ()=>{
    document.body.classList.toggle('accessible');
    toast(document.body.classList.contains('accessible') ? 'Tryb dostępności włączony' : 'Tryb dostępności wyłączony');
  };

  /* ===== TIMER ===== */
  function startTimer(){ clearInterval(timerInterval); updateTimer();
    timerInterval = setInterval(()=>{ state.timer--; updateTimer(); if(state.timer<=0){ clearInterval(timerInterval); finishQuiz(); toast('Czas minął!'); } },1000); }
  function updateTimer(){ const m=Math.floor(state.timer/60), s=state.timer%60; els.timer.textContent = `Czas: ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

  /* ===== RENDER PYTANIA ===== */
  let focusIndex = 0;
  function renderQuestion(){
    if(!state.pool.length){ els.qText.textContent='Brak pytań do wyświetlenia.'; els.answers.innerHTML=''; els.qIndex.textContent=0; els.qTotal.textContent=0; els.bar.style.width='0%'; els.percent.textContent='0%'; return; }
    const q = state.pool[state.current];
    els.qText.textContent = q.text;
    els.answers.innerHTML = ''; els.explanation.textContent = '';
    els.qIndex.textContent = state.current+1; els.qTotal.textContent = state.pool.length;
    const pct = Math.round((state.current/state.pool.length)*100); els.bar.style.width = pct+'%'; els.percent.textContent = pct+'%';

    els.dots.innerHTML = '';
    state.pool.forEach((_,i)=>{ const d=document.createElement('div'); d.className='dot'+(i===state.current?' active':''); d.onclick=()=>{state.current=i; renderQuestion();}; els.dots.appendChild(d); });

    if(q.image){ els.qImage.style.display='block'; els.qImage.src=q.image; els.qImage.alt=q.imageAlt||'Grafika do pytania'; els.qImageCap.textContent=q.imageAlt||''; els.qImage.onerror=()=>{ els.qImage.removeAttribute('src'); els.qImage.style.display='none'; els.qImageCap.textContent='Miejsce na grafikę (opcjonalnie)'; }; }
    else { els.qImage.removeAttribute('src'); els.qImage.style.display='none'; els.qImageCap.textContent='Miejsce na grafikę (opcjonalnie)'; }

    q.options.forEach((opt,idx)=>{ const btn=document.createElement('button'); btn.className='option'; btn.setAttribute('role','radio'); btn.setAttribute('aria-checked','false'); btn.setAttribute('tabindex','0'); btn.textContent=opt; btn.onclick=()=>selectAnswer(idx); els.answers.appendChild(btn); });
    focusIndex = 0; els.answers.children[0]?.focus();

    const prev = state.answers[state.current];
    if(prev){ [...els.answers.children].forEach((b,i)=>{ if(i===q.correct) b.classList.add('correct'); if(prev.choice===i && !prev.correct) b.classList.add('wrong'); b.disabled = true; }); els.explanation.textContent = q.why || ''; }
  }

  document.addEventListener('keydown', (e)=>{
    if(els.quiz.style.display==='none') return;
    const total = els.answers.children.length;
    if(e.key==='ArrowDown' || e.key==='ArrowRight'){ e.preventDefault(); focusIndex=(focusIndex+1)%total; els.answers.children[focusIndex]?.focus(); }
    if(e.key==='ArrowUp' || e.key==='ArrowLeft'){ e.preventDefault(); focusIndex=(focusIndex-1+total)%total; els.answers.children[focusIndex]?.focus(); }
    if(e.key==='Enter' || e.key===' '){ const idx=[...els.answers.children].indexOf(document.activeElement); if(idx>=0) selectAnswer(idx); }
  });

  function selectAnswer(idx){
    const q = state.pool[state.current]; const correct = idx===q.correct;
    state.answers[state.current] = { choice: idx, correct };
    [...els.answers.children].forEach((b,i)=>{ b.disabled=true; if(i===q.correct) b.classList.add('correct'); if(i===idx && !correct) b.classList.add('wrong'); b.setAttribute('aria-checked', i===idx ? 'true':'false'); });
    els.explanation.textContent = q.why || ''; saveProgress();
  }
  function next(){ if(state.current<state.pool.length-1){ state.current++; renderQuestion(); } else { finishQuiz(); } }
  function prev(){ if(state.current>0){ state.current--; renderQuestion(); } }

  function finishQuiz(){
    clearInterval(timerInterval);
    const good = state.answers.filter(a=>a&&a.correct).length;
    els.quiz.style.display='none'; els.result.style.display='block';
    els.score.textContent = `Wynik: ${good}/${state.pool.length} (${percent(good,state.pool.length)}%)`;
    const initial = state.initialTimer || 180; const elapsed = initial - Math.max(0, state.timer);
    const resultObj = { email, score: good, total: state.pool.length, seconds: elapsed, date: new Date().toLocaleString() };
    const hist = JSON.parse(localStorage.getItem('quizHistory') || '[]'); hist.push(resultObj);
    localStorage.setItem('quizHistory', JSON.stringify(hist)); localStorage.removeItem('quizProgress'); showStats();
  }

  function startQuiz(){
    const cat = els.category.value, limitPerLevel = 10, DEFAULT_TIME = 180;
    const maxForCat = cat==='mix'
      ? Math.min(limitPerLevel*3, (questions.latwe?.length||0)+(questions.srednie?.length||0)+(questions.trudne?.length||0))
      : Math.min(limitPerLevel, (questions[cat]||[]).length);
    if(maxForCat===0){ toast('Brak pytań w wybranej kategorii.'); return; }

    els.count.max = String(Math.max(1, maxForCat));
    const cnt = clampCount(Math.max(1, maxForCat));

    let pool=[];
    if(cat==='mix'){
      const l = shuffle([...(questions.latwe||[])]).slice(0, limitPerLevel);
      const s = shuffle([...(questions.srednie||[])]).slice(0, limitPerLevel);
      const t = shuffle([...(questions.trudne||[])]).slice(0, limitPerLevel);
      pool = shuffle([...l, ...s, ...t]).slice(0, cnt);
    } else {
      pool = shuffle([...(questions[cat]||[])]).slice(0, cnt);
    }

    state = { pool, current: 0, answers: new Array(pool.length), timer: DEFAULT_TIME, initialTimer: DEFAULT_TIME };
    els.settings.style.display='none'; els.quiz.style.display='block'; els.result.style.display='none';
    renderQuestion(); startTimer(); saveProgress();
  }

  function saveProgress(){ localStorage.setItem('quizProgress', JSON.stringify({state})); }
  function loadProgress(){
    const data=localStorage.getItem('quizProgress'); if(!data) return;
    try{ const saved=JSON.parse(data).state;
      if(saved && saved.pool && saved.pool.length){ state=saved; els.settings.style.display='none'; els.quiz.style.display='block'; els.result.style.display='none'; renderQuestion(); startTimer(); }
    }catch{}
  }

  function getHistory(){ try{return JSON.parse(localStorage.getItem('quizHistory')||'[]');}catch{return[];} }
  function avg(arr){ return !arr.length ? 0 : arr.reduce((a,b)=>a+b,0)/arr.length; }
  function renderStats(){
    const hist=getHistory(), count=hist.length;
    const avgScore=Math.round(avg(hist.map(h=>h.score))), avgTotal=Math.round(avg(hist.map(h=>h.total)));
    const avgPct=Math.round(avg(hist.map(h=>percent(h.score,h.total)))), avgTime=Math.round(avg(hist.map(h=>h.seconds)));
    els.statsSummary.innerHTML = `
      <div class="kpi"><div class="kpi-label">Liczba wyników</div><div class="kpi-value">${count}</div></div>
      <div class="kpi"><div class="kpi-label">Średni wynik</div><div class="kpi-value">${isNaN(avgScore)?0:avgScore}/${isNaN(avgTotal)?0:avgTotal}</div></div>
      <div class="kpi"><div class="kpi-label">Średnio %</div><div class="kpi-value">${isNaN(avgPct)?0:avgPct}%</div></div>
      <div class="kpi"><div class="kpi-label">Średni czas</div><div class="kpi-value">${isNaN(avgTime)?0:avgTime}s</div></div>`;
    const top=[...hist].sort((a,b)=>{ const pa=percent(a.score,a.total), pb=percent(b.score,b.total); if(pb!==pa) return pb-pa; return a.seconds-b.seconds; }).slice(0,5);
    els.leaderboard.innerHTML = top.length ? top.map(r=>`<li><strong>${r.email||'—'}</strong> - ${r.score}/${r.total} (${percent(r.score,r.total)}%), ${r.seconds}s</li>`).join('') : '<li>Brak danych</li>';
    const rows=[...hist].reverse().map((r,i)=>`<tr><td>${i+1}</td><td>${r.email||'—'}</td><td>${r.score}</td><td>${r.total}</td><td>${r.seconds}</td><td>${r.date}</td></tr>`).join('');
    els.historyTableBody.innerHTML = rows || '<tr><td colspan="6" style="color:var(--muted)">Brak wyników</td></tr>';

    const buckets=new Array(10).fill(0); hist.forEach(h=>{ const p=percent(h.score,h.total); const b=Math.min(9,Math.floor(p/10)); buckets[b]++; });
    drawChart('chartScores','bar',{labels:['0-9%','10-19%','20-29%','30-39%','40-49%','50-59%','60-69%','70-79%','80-89%','90-100%'], datasets:[{label:'Liczba osób', data:buckets}]});
    const lvl = { 'Poziom (10 pytań)': hist.filter(h=>h.total===10).length, 'Miks (30 pytań)': hist.filter(h=>h.total===30).length };
    drawChart('chartLevels','pie',{labels:Object.keys(lvl), datasets:[{data:Object.values(lvl)}]});
    const byDay = {}; hist.forEach(h=>{ const d = new Date(h.date); const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; byDay[key]=(byDay[key]||0)+1; });
    const days = Object.keys(byDay).sort(); drawChart('chartTimeline','line',{labels:days, datasets:[{label:'Próby', data:days.map(d=>byDay[d])}]});
  }
  function drawChart(id,type,dataCfg){
    const ctx = document.getElementById(id).getContext('2d');
    if(charts[id]) charts[id].destroy();
    charts[id] = new Chart(ctx, { type, data: dataCfg, options:{
      responsive:true,
      plugins:{ legend:{labels:{color:getComputedStyle(document.body).getPropertyValue('--text')}}, tooltip:{} },
      scales: type==='pie' ? {} : {
        x:{ ticks:{ color:getComputedStyle(document.body).getPropertyValue('--muted') }, grid:{ color:'rgba(148,163,184,.2)'} },
        y:{ ticks:{ color:getComputedStyle(document.body).getPropertyValue('--muted') }, grid:{ color:'rgba(148,163,184,.2)'} }
      }
    }});
  }
  function showStats(){ els.stats.style.display='block'; renderStats(); }

  /* ===== ZDARZENIA ===== */
  els.startBtn.onclick=startQuiz;
  els.nextBtn.onclick=next;
  els.prevBtn.onclick=prev;
  els.retryBtn.onclick=()=>{ localStorage.removeItem('quizProgress'); location.reload(); };
  els.statsBtn.onclick=showStats;
  els.refreshStats.onclick=renderStats;
  els.clearHistory.onclick=()=>{ localStorage.removeItem('quizHistory'); renderStats(); toast('Wyczyszczono lokalną historię.'); };
  els.downloadCsv.onclick=downloadCsvCommon;
  els.downloadCsv2.onclick=downloadCsvCommon;
  els.exportJson.onclick=exportJson;
  els.demoBtn.onclick=generateDemoData;

  /* ===== ŁADOWANIE PYTAŃ Z assets/questions.json ===== */
  (function loadQuestions(){
    // przycisk Start zablokowany do skutecznego wczytania
    els.startBtn.disabled = true;

    // ostrzeż tylko raz, jeśli uruchomiono jako file:// (fetch JSON bywa blokowany)
    if(location.protocol === 'file:'){
      toast('Wskazówka: iść przez http (np. Live Server), jeśli JSON nie wczyta się lokalnie.');
    }

    fetch('assets/questions.json?ts=' + Date.now(), { cache:'no-store' })
      .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
      .then(txt=>{
        const clean = txt.replace(/^\uFEFF/,''); // usuń BOM, jeśli edytor go dodał
        const d = JSON.parse(clean);
        if(!d || !Array.isArray(d.latwe) || !Array.isArray(d.srednie) || !Array.isArray(d.trudne)){
          throw new Error('Zła struktura JSON (latwe/srednie/trudne muszą być tablicami).');
        }
        questions = d;

        // ustaw limity po wczytaniu
        const cat=els.category.value, limit=10;
        const maxForCat = cat==='mix'
          ? Math.min(limit*3, (questions.latwe.length + questions.srednie.length + questions.trudne.length))
          : Math.min(limit, (questions[cat]||[]).length);
        els.count.max = String(Math.max(1, maxForCat)); clampCount(Math.max(1, maxForCat));

        els.startBtn.disabled = false; // gotowe do startu
      })
      .catch(err=>{
        console.error('[questions.json]', err);
        els.startBtn.disabled = true;
        els.startBtn.textContent = 'Błąd ładowania pytań';
        toast('Nie udało się pobrać assets/questions.json. Sprawdź ścieżkę lub uruchom przez http.');
      });
  })();

  /* ===== DEMO / EXPORT / MODAL / LOGOUT / ADMIN ===== */
  function generateDemoData(){
    const domains=['twojafirma.pl','firma.pl','example.com']; const now=new Date();
    const hist=JSON.parse(localStorage.getItem('quizHistory')||'[]');
    for(let i=1;i<=50;i++){
      const total=Math.random()<0.65?10:30;
      const score=Math.max(0,Math.min(total,Math.round(total*(0.45+Math.random()*0.4))));
      const seconds=35+Math.floor(Math.random()*145);
      const pastDays=Math.floor(Math.random()*30);
      const date=new Date(now.getTime()-pastDays*24*60*60*1000);
      const uid=String(i).padStart(2,'0'); const e=`demo${uid}@${domains[Math.floor(Math.random()*domains.length)]}`;
      hist.push({email:e,score,total,seconds,date:date.toLocaleString()});
    }
    localStorage.setItem('quizHistory', JSON.stringify(hist));
    toast('Dodano 50 wyników demo.'); renderStats();
  }
  function downloadCsvCommon(){
    const hist=getHistory(); if(!hist.length){ toast('Brak zapisanych wyników'); return; }
    const header=['E-mail','Wynik','Liczba pytań','Czas (s)','Data'];
    const rows=hist.map(r=>[r.email||'',r.score,r.total,r.seconds,r.date]);
    const csv=[header,...rows].map(e=>e.join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='historia_quiz.csv'; a.click(); URL.revokeObjectURL(url);
  }
  els.aboutBtn.onclick=()=>{ document.body.classList.add('no-scroll'); els.aboutModal.classList.add('show'); };
  els.closeAbout.onclick=()=>{ els.aboutModal.classList.remove('show'); document.body.classList.remove('no-scroll'); };
  els.logoutBtn.onclick=()=>{ localStorage.removeItem('quizUserEmail'); location.href='login.html'; };
  (function adminSecret(){ let clicks=0,t=null; document.querySelector('.site-logo').addEventListener('click',()=>{ clicks++; if(!t) t=setTimeout(()=>{clicks=0;t=null;},3000); if(clicks>=5){ isAdmin=!isAdmin; localStorage.setItem('isAdmin',isAdmin?'1':'0'); els.adminBadge.style.display=isAdmin?'inline-flex':'none'; toast(isAdmin?'Tryb ADMIN włączony':'Tryb ADMIN wyłączony'); } }); })();
</script>
</body>
</html>
